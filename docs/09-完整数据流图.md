# 完整数据流图

```mermaid
graph TB
    subgraph 用户层
        U1[用户操作]
    end
    
    subgraph 前端层
        F1[React应用]
        F2[状态管理]
    end
    
    subgraph API层
        A1[REST API Gateway]
        A2[认证中间件]
        A3[业务逻辑层]
    end
    
    subgraph 服务层
        S1[用户服务]
        S2[分类服务]
        S3[速记服务]
        S4[事件服务]
        S5[搜索服务]
        S6[录音服务]
        S7[展示服务]
    end
    
    subgraph AI层
        L1[LangChain Agent]
        L2[LLM模型]
        L3[嵌入模型]
    end
    
    subgraph 数据层
        M1[(MySQL)]
        G1[(Neo4j)]
        R1[(Redis)]
        OSS[对象存储]
    end
    
    subgraph 基础设施层
        MQ[消息队列]
        TS[定时任务]
        LOG[日志系统]
    end
    
    U1 --> F1
    F1 --> F2
    F2 --> A1
    
    A1 --> A2
    A2 --> A3
    A3 --> S1
    A3 --> S2
    A3 --> S3
    A3 --> S4
    A3 --> S5
    A3 --> S6
    A3 --> S7
    
    S1 --> M1
    S1 --> G1
    S1 --> R1
    
    S2 --> G1
    S2 --> L1
    L1 --> L2
    L2 --> G1
    
    S3 --> M1
    S3 --> G1
    S3 --> L1
    L1 --> L3
    L3 --> G1
    
    S4 --> M1
    S4 --> G1
    S4 --> L1
    L1 --> L2
    
    S5 --> G1
    S5 --> R1
    S5 --> L1
    L1 --> L3
    
    S6 --> OSS
    S6 --> M1
    S6 --> G1
    S6 --> L1
    
    S7 --> G1
    S7 --> M1
    S7 --> R1
    
    S3 --> MQ
    S4 --> MQ
    MQ --> TS
    TS --> G1
    TS --> M1
    
    S1 --> LOG
    S2 --> LOG
    S3 --> LOG
    S4 --> LOG
    S5 --> LOG
    S6 --> LOG
    S7 --> LOG
    
    style G1 fill:#bbf,stroke:#333,stroke-width:3px
    style M1 fill:#bfb,stroke:#333,stroke-width:3px
    style R1 fill:#fbb,stroke:#333,stroke-width:3px
    style L1 fill:#f9f,stroke:#333,stroke-width:3px
```

## 核心业务流

### 1. 注册流程数据流

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant API as API服务
    participant LangChain as LangChain
    participant MySQL as MySQL
    participant Neo4j as Neo4j
    participant Redis as Redis
    
    Client->>API: POST /register
    API->>MySQL: INSERT users
    MySQL-->>API: user_id
    
    Note over Client,API: 用户选择一级分类
    
    API->>LangChain: 生成二级分类
    LangChain->>LangChain: LLM生成
    LangChain-->>API: 二级分类列表
    
    Note over Client,API: 用户确认分类
    
    API->>MySQL: INSERT user_preferences
    API->>Neo4j: 创建用户节点
    API->>Neo4j: 创建分类节点
    API->>Neo4j: 创建PREFERS关系
    API->>Redis: 缓存用户信息
    
    API-->>Client: 注册成功
```

### 2. 事件创建数据流

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant API as API服务
    participant MySQL as MySQL
    participant Neo4j as Neo4j
    participant LangChain as LangChain
    participant MQ as 消息队列
    participant Worker as 后台Worker
    
    Client->>API: POST /events
    API->>MySQL: INSERT events
    MySQL-->>API: event_id
    
    API->>Neo4j: 创建Event节点
    Neo4j-->>API: 节点创建
    
    API->>LangChain: 全局关联分析
    LangChain->>LangChain: 提取关键信息
    LangChain->>MySQL: 查询所有分类
    LangChain->>MySQL: 查询所有标签
    LangChain->>MySQL: 查询所有事件
    LangChain->>MySQL: 查询所有速记
    LangChain->>LangChain: LLM分析关联
    LangChain-->>API: 关联建议
    
    API->>Neo4j: 创建关系边
    API->>MQ: 推送关联任务
    MQ-->>API: 任务入队
    
    API-->>Client: 事件创建成功
    
    Note over MQ,Worker: 异步处理
    
    MQ->>Worker: 消费任务
    Worker->>Neo4j: 更新关系权重
    Worker->>Neo4j: 清理弱关系
    Worker->>Redis: 清除缓存
    Worker->>MQ: 任务完成
```

### 3. 速记创建数据流

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant API as API服务
    participant MySQL as MySQL
    participant Neo4j as Neo4j
    participant Redis as Redis
    participant LangChain as LangChain
    
    Client->>API: POST /notes
    API->>MySQL: INSERT notes
    MySQL-->>API: note_id
    
    API->>Redis: 检查关系图谱缓存
    Redis-->>API: 缓存数据
    
    API->>Neo4j: 创建Note节点
    Neo4j-->>API: 节点创建
    
    API->>LangChain: 增量关联分析
    LangChain->>LangChain: 分析速记内容
    LangChain->>Neo4j: 查询一度关系
    Neo4j-->>LangChain: 一度关系节点
    LangChain->>Neo4j: 查询二度关系
    Neo4j-->>LangChain: 二度关系节点
    
    LangChain->>LangChain: 生成关联建议
    LangChain->>LangChain: 生成智能标签
    
    LangChain->>Neo4j: 创建Tag节点
    LangChain->>Neo4j: 创建关系边
    
    LangChain->>Redis: 清除缓存
    
    LangChain-->>API: 处理完成
    API-->>Client: 速记创建成功
```

### 4. 录音转文字数据流

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant API as API服务
    participant OSS as 对象存储
    participant STT as 语音识别服务
    participant MySQL as MySQL
    participant Neo4j as Neo4j
    participant LangChain as LangChain
    
    Client->>API: 上传音频
    API->>OSS: 存储音频文件
    OSS-->>API: 音频URL
    
    API->>API: 创建临时速记
    API->>MySQL: INSERT notes (status=processing)
    MySQL-->>API: note_id
    
    API->>STT: 发起语音识别
    STT->>STT: 音频转文字
    STT-->>API: 转录文本
    
    API->>LangChain: 文本后处理
    LangChain->>LangChain: 添加标点
    LangChain->>LangChain: 分段处理
    
    API->>MySQL: 更新notes内容
    API->>Neo4j: 创建Note节点
    API->>LangChain: 关联分析
    
    LangChain->>LangChain: 生成标签
    LangChain->>LangChain: 关联内容
    LangChain->>Neo4j: 创建关系
    
    API->>MySQL: 更新status=completed
    API-->>Client: 处理完成
```

### 5. 搜索流程数据流

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant API as API服务
    participant Redis as Redis
    participant LangChain as LangChain
    participant Neo4j as Neo4j
    participant VectorDB as 向量数据库
    
    Client->>API: GET /search?q=keyword
    API->>Redis: 检查缓存
    Redis-->>API: 缓存命中/未命中
    
    alt 缓存未命中
        API->>LangChain: 智能搜索
        
        LangChain->>LangChain: 分析搜索意图
        LangChain->>LangChain: 提取关键实体
        
        par 向量搜索
            LangChain->>VectorDB: 语义检索
            VectorDB-->>LangChain: 相似文档
        and 图搜索
            LangChain->>Neo4j: 图查询1
            LangChain->>Neo4j: 图查询2
            Neo4j-->>LangChain: 图数据
        end
        
        LangChain->>LangChain: 合并结果
        LangChain->>LangChain: 重排序
        LangChain->>LangChain: 生成解释
        
        LangChain-->>API: 搜索结果
        
        API->>Redis: 缓存结果
        Redis-->>API: 缓存成功
    end
    
    API-->>Client: 搜索结果
```

### 6. 展示流程数据流

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant API as API服务
    participant Redis as Redis
    participant Neo4j as Neo4j
    participant LangChain as LangChain
    
    Client->>API: GET /timeline?date=2024-01
    API->>Redis: 检查时间轴缓存
    Redis-->>API: 缓存命中/未命中
    
    alt 缓存未命中
        API->>Neo4j: 时间范围查询
        Neo4j-->>API: 节点列表
        
        API->>Neo4j: 查询关系
        Neo4j-->>API: 关系数据
        
        API->>API: 构建时间轴结构
        
        API->>LangChain: 计算重要性
        LangChain-->>API: 重要性评分
        
        API->>Redis: 缓存时间轴
        Redis-->>API: 缓存成功
    end
    
    API-->>Client: 时间轴数据
    
    Note over Client: 用户点击节点
    
    Client->>API: GET /notes/:id
    API->>Neo4j: 节点详情
    API->>Neo4j: 查询关联内容
    Neo4j-->>API: 详细数据
    API-->>Client: 详情数据
```

## 技术栈集成关系

### MySQL数据模型

```sql
-- 用户相关
users (id, username, email, password_hash, ...)
user_preferences (id, user_id, categories, created_at)

-- 内容相关
notes (id, user_id, title, content, source, audio_url, ...)
events (id, user_id, title, event_type, status, priority, ...)
audio_recordings (id, note_id, audio_url, transcript_text, ...)

-- 任务相关
relation_tasks (id, entity_type, entity_id, status, ...)
transcript_segments (id, recording_id, text, start_time, ...)
```

### Neo4j图模型

```cypher
-- 节点类型
(:User)
(:Category)
(:Tag)
(:Event)
(:Note)
(:Audio)

-- 关系类型
(:User)-[:PREFERS]->(:Category)
(:User)-[:CREATED]->(:Event)
(:User)-[:CREATED]->(:Note)
(:Note)-[:BELONGS_TO]->(:Category)
(:Event)-[:BELONGS_TO]->(:Category)
(:Note)-[:TAGGED_WITH]->(:Tag)
(:Event)-[:RELATED_TO]->(:Note)
(:Note)-[:RELATED_TO]->(:Event)
(:Note)-[:CONTAINS]->(:Audio)
(:Event)-[:DEPENDS_ON]->(:Event)
(:Event)-[:BLOCKS]->(:Event)
(:Note)-[:MENTIONS]->(:Event)
```

### Redis数据结构

```
-- 用户缓存
user:{user_id}:info {json}
user:{user_id}:timeline {json}
user:{user_id}:relationships {json}

-- 分类缓存
category:tree {json}
category:{category_id}:notes {list}
category:{category_id}:children {json}

-- 搜索缓存
search:{hash} {json} (TTL: 5min)
search:history:{user_id} {list}

-- 会话缓存
session:{session_id} {json} (TTL: 24h)
```

### LangChain Agent工具链

```python
# 分类生成Agent
Tools:
- 查询一级分类列表
- LLM基于一级分类生成二级分类
- LLM推荐热门分类
- 推送到Neo4j创建节点

# 关联分析Agent（全局）
Tools:
- 查询所有分类
- 查询所有标签
- 查询所有事件
- 查询所有速记
- LLM分析语义相似度
- LLM判断因果/依赖关系

# 关联分析Agent（增量）
Tools:
- 从缓存/Neo4j读取用户图谱
- LLM分析新内容与图谱关联
- 提取一度关系
- 计算二度关系潜力
- 生成连接建议

# 标签生成Agent
Tools:
- 分析内容关键词
- 查询现有标签
- LLM生成新标签
- LLM匹配现有标签
- 推送创建Tag节点

# 搜索Agent
Tools:
- 分析搜索意图
- 向量相似度搜索
- Neo4j图查询
- 结果合并与重排
- 生成搜索解释
```

## 系统关键指标

### 性能指标
- API响应时间: < 500ms (P95)
- 搜索响应时间: < 1s (P95)
- 录音转文字: < 30s (10分钟音频)
- 关联分析: < 5s (单条速记)

### 可用性指标
- 系统可用性: 99.9%
- 数据一致性: 强一致性
- 缓存命中率: > 80%

### 数据规模
- 单用户节点数: < 10,000
- 单用户关系数: < 50,000
- 搜索索引: 全文索引 + 向量索引
```
