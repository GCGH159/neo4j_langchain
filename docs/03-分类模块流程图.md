# 分类模块详细流程

```mermaid
flowchart TD
    Start([分类管理入口]) --> A{操作类型}
    
    A -->|查看分类| B[从Neo4j查询分类树]
    A -->|添加分类| C[创建新分类]
    A -->|管理标签| D[标签管理]
    A -->|查看关系| E[关系图谱]
    
    B --> B1[从Redis缓存读取]
    B1 --> B2{缓存命中?}
    B2 -->|是| B3[返回分类数据]
    B2 -->|否| B4[从Neo4j查询]
    B4 --> B5[写入Redis缓存]
    B5 --> B3
    
    C --> C1[用户输入分类信息]
    C1 --> C2[保存到Neo4j]
    C2 --> C3[触发关联分析]
    C3 --> C4[LangChain Agent分析关联]
    C4 --> C5[查找相似分类和事件]
    C5 --> C6[创建关联关系]
    C6 --> C7[更新关系权重]
    C7 --> C8[清除Redis缓存]
    
    D --> D1[查询现有标签]
    D1 --> D2{操作}
    D2 -->|创建| D3[新建标签节点]
    D2 -->|编辑| D4[更新标签属性]
    D2 -->|删除| D5[删除标签及关系]
    
    D3 --> D6[在Neo4j中创建Tag节点]
    D4 --> D6
    D5 --> D6
    
    E --> E1[选择查询维度]
    E1 --> E2{维度类型}
    E2 -->|按分类| E3[MATCH分类关系路径]
    E2 -->|按标签| E4[MATCH标签关系路径]
    E2 -->|按事件| E5[MATCH事件关系路径]
    E2 -->|综合| E6[MATCH多维度路径]
    
    E3 --> E7[返回关系图谱]
    E4 --> E7
    E5 --> E7
    E6 --> E7
    
    E7 --> End([完成])
    B3 --> End
    C8 --> End
    D6 --> End
    
    style C4 fill:#f9f,stroke:#333,stroke-width:2px
    style C5 fill:#f9f,stroke:#333,stroke-width:2px
    style C2 fill:#bbf,stroke:#333,stroke-width:2px
    style D6 fill:#bbf,stroke:#333,stroke-width:2px
```

## 分类体系设计

### Neo4j图数据模型

```cypher
// 节点类型
(:User)           // 用户
(:Category)       // 分类
(:Tag)           // 标签
(:Event)         // 事件
(:Note)          // 速记

// 关系类型
-[:PREFERS]->           // 用户偏好分类
-[:BELONGS_TO]->        // 属于某个分类
-[:TAGGED_WITH]->       // 标记了某个标签
-[:RELATED_TO]->        // 相关联
-[:SIMILAR_TO]->        // 相似
-[:TRIGGERED_BY]->      // 由某事件触发
-[:CONTAINS]->          // 包含
-[:DEPENDS_ON]->        // 依赖于
```

### 多维度查询示例

#### 1. 按分类查询
```cypher
MATCH path = (u:User {id: $userId})-[:PREFERS]->(c:Category)<-[:BELONGS_TO*1..3]-(n:Note)
WHERE n.created_at > $startDate
RETURN path
```

#### 2. 按标签查询
```cypher
MATCH path = (u:User {id: $userId})-[:CREATED]->(n:Note)-[:TAGGED_WITH]->(t:Tag)
WHERE t.name IN $tagList
RETURN path, n, t
ORDER BY n.created_at DESC
```

#### 3. 按事件关联查询
```cypher
MATCH path = (e:Event {id: $eventId})-[:RELATED_TO*1..2]-(n:Note)
RETURN path, n
ORDER BY path.weight DESC
```

#### 4. 综合维度查询（最复杂）
```cypher
MATCH (u:User {id: $userId})
OPTIONAL MATCH path1 = (u)-[:CREATED]->(n:Note)-[:BELONGS_TO]->(c:Category)
OPTIONAL MATCH path2 = (n)-[:TAGGED_WITH]->(t:Tag)
OPTIONAL MATCH path3 = (n)-[:RELATED_TO]->(e:Event)
WHERE (c.name IN $categories OR $categories IS NULL)
  AND (t.name IN $tags OR $tags IS NULL)
  AND (e.id IN $events OR $events IS NULL)
  AND n.created_at BETWEEN $startDate AND $endDate
RETURN DISTINCT n, 
       collect(DISTINCT c) as categories,
       collect(DISTINCT t) as tags,
       collect(DISTINCT e) as events
ORDER BY n.created_at DESC
LIMIT 50
```

## LangChain关联分析Agent

```python
from langchain.agents import AgentExecutor, create_openai_functions_agent
from langchain.tools import Tool

# 关联分析工具
def find_related_items(query: str, item_type: str) -> list:
    """
    查找相关的分类、标签或事件
    """
    # 1. 向量相似度搜索
    # 2. Neo4j图遍历
    # 3. 返回相关项列表
    pass

# 创建Agent
agent = create_openai_functions_agent(
    llm=llm,
    tools=[
        Tool(
            name="find_related_categories",
            func=lambda q: find_related_items(q, "category"),
            description="查找相关的分类"
        ),
        Tool(
            name="find_related_events",
            func=lambda q: find_related_items(q, "event"),
            description="查找相关的事件"
        )
    ],
    prompt=prompt
)
```
