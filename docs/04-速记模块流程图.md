# 速记模块详细流程

## 整体流程对比

```mermaid
flowchart TD
    Start([用户创建内容]) --> A{内容类型}
    
    A -->|事件Event| B[事件处理流程]
    A -->|速记Note| C[速记处理流程]
    
    B --> B1[用户输入事件信息]
    B1 --> B2[保存事件到MySQL基础表]
    B2 --> B3[在Neo4j创建Event节点]
    B3 --> B4[调用LangChain Agent全局关联分析]
    
    B4 --> B5[Agent决策流程]
    B5 --> B51[分析事件重要性和影响范围]
    B51 --> B52[检索所有可能相关内容]
    B52 --> B521[查询相关分类]
    B52 --> B522[查询相关标签]
    B52 --> B523[查询相关事件]
    B52 --> B524[查询相关速记]
    
    B521 --> B53[计算关联度评分]
    B522 --> B53
    B523 --> B53
    B524 --> B53
    
    B53 --> B54[创建关联关系]
    B54 --> B55[设置关系权重]
    B55 --> B56[添加到消息队列异步处理]
    B56 --> B6[返回事件创建成功]
    
    C --> C1[用户输入速记内容]
    C1 --> C2[保存速记到MySQL基础表]
    C2 --> C3[在Neo4j创建Note节点]
    C3 --> C4[调用LangChain Agent增量关联分析]
    
    C4 --> C5[Agent决策流程]
    C5 --> C51[查询当前用户的关系图谱]
    C51 --> C52[基于现有关系推荐关联]
    C52 --> C521[一度关系查询]
    C52 --> C522[二度关系扩展]
    
    C521 --> C53[生成关联建议]
    C522 --> C53
    C53 --> C54[生成智能标签]
    C54 --> C55[关联到分类]
    C55 --> C56[创建关系边]
    C56 --> C57[更新关系权重]
    C57 --> C6[返回速记创建成功]
    
    B6 --> End([完成])
    C6 --> End
    
    style B4 fill:#f9f,stroke:#333,stroke-width:2px
    style B5 fill:#f9f,stroke:#333,stroke-width:2px
    style C4 fill:#f9f,stroke:#333,stroke-width:2px
    style C5 fill:#f9f,stroke:#333,stroke-width:2px
    style B3 fill:#bbf,stroke:#333,stroke-width:2px
    style C3 fill:#bbf,stroke:#333,stroke-width:2px
```

## 事件处理详细流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant API as API服务
    participant MySQL as MySQL
    participant Neo4j as Neo4j图库
    participant Agent as LangChain Agent
    participant MQ as 消息队列
    participant Worker as 后台Worker
    
    U->>API: 创建事件
    API->>MySQL: 保存事件基础信息
    MySQL-->>API: 返回事件ID
    
    API->>Neo4j: 创建Event节点
    Neo4j-->>API: 节点创建成功
    
    API->>Agent: 启动全局关联分析
    
    Agent->>Neo4j: 查询所有分类
    Neo4j-->>Agent: 返回分类列表
    
    Agent->>Neo4j: 查询所有标签
    Neo4j-->>Agent: 返回标签列表
    
    Agent->>Neo4j: 查询所有事件
    Neo4j-->>Agent: 返回事件列表
    
    Agent->>Neo4j: 查询所有速记
    Neo4j-->>Agent: 返回速记列表
    
    Agent->>Agent: LLM分析关联度
    Agent->>Agent: 计算关系权重
    
    Agent->>MQ: 推送关联任务
    MQ-->>Agent: 任务入队成功
    
    Agent-->>API: 返回初步分析结果
    API-->>U: 事件创建成功
    
    MQ->>Worker: 消费关联任务
    Worker->>Neo4j: 批量创建关系边
    Neo4j-->>Worker: 关系创建完成
    
    Worker->>Neo4j: 更新关系权重
    Neo4j-->>Worker: 权重更新完成
```

## 速记处理详细流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant API as API服务
    participant MySQL as MySQL
    participant Neo4j as Neo4j图库
    participant Redis as Redis缓存
    participant Agent as LangChain Agent
    
    U->>API: 创建速记
    API->>MySQL: 保存速记基础信息
    MySQL-->>API: 返回速记ID
    
    API->>Neo4j: 创建Note节点
    Neo4j-->>API: 节点创建成功
    
    API->>Redis: 检查用户关系图谱缓存
    Redis-->>API: 返回缓存数据/未命中
    
    alt 缓存未命中
        API->>Neo4j: 查询用户关系图谱
        Neo4j-->>API: 返回关系数据
        API->>Redis: 更新缓存
    end
    
    API->>Agent: 启动增量关联分析
    
    Agent->>Agent: 分析速记内容
    Agent->>Neo4j: 查询一度关系节点
    Neo4j-->>Agent: 返回直接相关节点
    
    Agent->>Neo4j: 查询二度关系节点
    Neo4j-->>Agent: 返回间接相关节点
    
    Agent->>Agent: LLM生成智能标签
    Agent->>Agent: 推荐关联分类
    Agent->>Agent: 计算关系权重
    
    Agent->>Neo4j: 创建Tag节点（如果新标签）
    Neo4j-->>Agent: 标签创建成功
    
    Agent->>Neo4j: 创建关系边
    Neo4j-->>Agent: 关系创建成功
    
    Agent->>Redis: 清除相关缓存
    Redis-->>Agent: 缓存清除成功
    
    Agent-->>API: 返回处理结果
    API-->>U: 速记创建成功
```

## 数据模型

### MySQL表结构

```sql
-- 事件表
CREATE TABLE events (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    event_type ENUM('project', 'long_term_task', 'important_event', 'personality') NOT NULL,
    status ENUM('pending', 'in_progress', 'completed', 'cancelled') DEFAULT 'pending',
    priority INT DEFAULT 0,
    start_date DATE,
    end_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 速记表
CREATE TABLE notes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(255),
    content TEXT NOT NULL,
    source ENUM('text', 'audio', 'image') DEFAULT 'text',
    audio_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 关联任务队列表
CREATE TABLE relation_tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_type ENUM('event_relation', 'note_relation', 'tag_generation') NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id BIGINT NOT NULL,
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    retry_count INT DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP NULL,
    INDEX idx_status (status),
    INDEX idx_entity (entity_type, entity_id)
);
```

### Neo4j图模型

```cypher
// 事件节点
CREATE (e:Event {
    id: $eventId,
    user_id: $userId,
    title: $title,
    description: $description,
    event_type: $eventType,
    priority: $priority,
    created_at: datetime()
})

// 速记节点
CREATE (n:Note {
    id: $noteId,
    user_id: $userId,
    title: $title,
    content: $content,
    source: $source,
    created_at: datetime()
})

// 关系类型及属性
// 事件关系
-[:RELATED_TO {weight: 0.85, reason: 'topic_similarity'}]->
-[:TRIGGERED_BY {weight: 0.90, timestamp: datetime()}]->
-[:DEPENDS_ON {weight: 0.75, dependency_type: 'resource'}]->
-[:BLOCKS {weight: 0.70}]->

// 速记关系
-[:MENTIONS {weight: 0.80, context: 'reference'}]->
-[:EXTENDS {weight: 0.85, extension_type: 'detail'}]->
-[:CONTRADICTS {weight: 0.60}]->

// 通用关系
-[:TAGGED_WITH {confidence: 0.95, auto_generated: true}]->
-[:BELONGS_TO {weight: 1.0}]->
-[:CREATED_BY]->
```

## LangChain Agent实现

### 事件关联Agent

```python
from langchain.agents import AgentExecutor
from langchain.prompts import ChatPromptTemplate
from langchain.tools import tool

@tool
def search_all_content(event_info: dict) -> dict:
    """搜索所有可能相关的内容"""
    results = {
        'categories': [],
        'tags': [],
        'events': [],
        'notes': []
    }
    
    # 向量检索 + 关键词匹配
    # ... 实现逻辑
    
    return results

@tool
def calculate_relevance(source: dict, targets: list) -> list:
    """计算关联度评分"""
    scores = []
    for target in targets:
        # 使用LLM计算语义相似度
        score = llm.predict(
            f"计算以下两个内容的关联度(0-1):\n源:{source}\n目标:{target}"
        )
        scores.append({
            'target': target,
            'score': float(score),
            'reason': '...'
        })
    return scores

event_agent_prompt = ChatPromptTemplate.from_messages([
    ("system", """你是一个事件关联分析专家。
    任务：分析新创建的事件，找出所有可能相关的内容并建立关联。
    
    分析维度：
    1. 主题相关性
    2. 时间关联
    3. 因果关系
    4. 资源依赖
    5. 情感影响
    
    输出：关联关系列表，包含关系类型、权重和理由。
    """),
    ("user", "{input}")
])

event_agent = create_agent(
    llm=llm,
    tools=[search_all_content, calculate_relevance],
    prompt=event_agent_prompt
)
```

### 速记关联Agent

```python
@tool
def query_user_graph(user_id: int, note_content: str) -> dict:
    """查询用户的关系图谱"""
    # 从Neo4j查询用户的现有关系
    query = """
    MATCH (u:User {id: $userId})-[r*1..2]-(n)
    WHERE n:Category OR n:Tag OR n:Event OR n:Note
    RETURN n, type(r), properties(r)
    LIMIT 100
    """
    return neo4j_client.run(query, userId=user_id)

@tool
def generate_smart_tags(content: str, existing_tags: list) -> list:
    """生成智能标签"""
    prompt = f"""
    基于以下内容生成3-5个标签：
    内容：{content}
    
    现有标签参考（优先使用）：{existing_tags}
    
    要求：
    1. 标签要准确反映除内容主题
    2. 优先使用现有标签
    3. 新标签要简洁明了
    """
    tags = llm.predict(prompt)
    return parse_tags(tags)

note_agent_prompt = ChatPromptTemplate.from_messages([
    ("system", """你是速记关联分析专家。
    任务：基于用户现有的关系图谱，为新创建的速记建立智能关联。
    
    策略：
    1. 首先查询用户的一度关系（直接相关）
    2. 扩展到二度关系（间接相关）
    3. 基于关系权重和内容相似度推荐关联
    4. 自动生成智能标签
    5. 关联到合适的分类
    
    输出：建议的关联关系、生成的新标签、推荐的分类。
    """),
    ("user", "{input}")
])

note_agent = create_agent(
    llm=llm,
    tools=[query_user_graph, generate_smart_tags],
    prompt=note_agent_prompt
)
```
