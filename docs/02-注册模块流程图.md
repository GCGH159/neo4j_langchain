# 注册模块详细流程

```mermaid
flowchart TD
    Start([用户开始注册]) --> A[填写基本信息]
    A --> B{验证信息}
    B -->|失败| A
    B -->|成功| C[保存用户信息到MySQL]
    
    C --> D[展示一级分类选择]
    D --> D1[偏爱用户]
    D --> D2[学习资料]
    D --> D3[刊物]
    D --> D4[运动]
    D --> D5[其他...]
    
    D1 --> E{用户选择}
    D2 --> E
    D3 --> E
    D4 --> E
    D5 --> E
    
    E --> F[调用LangChain生成二级分类]
    F --> G[LLM根据一级分类生成个性化二级分类]
    
    G --> H[展示二级分类供用户选择]
    H --> I{用户操作}
    
    I -->|选择部分| J[记录用户选择]
    I -->|跳过| K[默认全选二级分类]
    
    J --> L[保存分类偏好到MySQL]
    K --> L
    
    L --> M[在Neo4j中创建用户节点]
    M --> N[创建用户-分类关系边]
    N --> O[初始化Redis用户缓存]
    
    O --> End([注册完成])
    
    style F fill:#f9f,stroke:#333,stroke-width:2px
    style G fill:#f9f,stroke:#333,stroke-width:2px
    style M fill:#bbf,stroke:#333,stroke-width:2px
    style N fill:#bbf,stroke:#333,stroke-width:2px
```

## 数据模型

### MySQL - users表
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_email (email)
);

CREATE TABLE user_preferences (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    category_level_1 VARCHAR(50) NOT NULL,
    category_level_2 TEXT, -- JSON array
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### Neo4j - 用户和分类节点
```cypher
// 创建用户节点
CREATE (u:User {
    id: $userId,
    username: $username,
    created_at: datetime()
})

// 创建分类节点
CREATE (c1:Category {
    id: $categoryId,
    name: $categoryName,
    level: 1,
    created_at: datetime()
})

CREATE (c2:Category {
    id: $subCategoryId,
    name: $subCategoryName,
    level: 2,
    parent_id: $categoryId,
    created_at: datetime()
})

// 创建关系
CREATE (u)-[:PREFERS {weight: 1.0}]->(c1)
CREATE (u)-[:PREFERS {weight: 0.8}]->(c2)
CREATE (c2)-[:BELONGS_TO]->(c1)
```
